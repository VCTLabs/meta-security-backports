From 35c26c5acc999ffcd0202166bdf814e69a81774d Mon Sep 17 00:00:00 2001
From: Stephen L Arnold <sarnold@vctlabs.com>
Date: Mon, 3 Jul 2023 21:40:51 -0700
Subject: [PATCH 2/7] scap-security-guide: add Poky support (rebase from
 meta-security)

Signed-off-by: Stephen L Arnold <sarnold@vctlabs.com>
---
 products/openembedded/product.yml             |  5 +++
 .../openembedded/transforms/constants.xslt    |  4 +--
 shared/checks/oval/installed_OS_is_poky.xml   | 33 +++++++++++++++++++
 .../oval/sysctl_kernel_ipv6_disable.xml       |  4 +--
 ssg/constants.py                              |  1 +
 5 files changed, 43 insertions(+), 4 deletions(-)
 create mode 100644 shared/checks/oval/installed_OS_is_poky.xml

diff --git a/products/openembedded/product.yml b/products/openembedded/product.yml
index a1efb33116..dbe8eccf97 100644
--- a/products/openembedded/product.yml
+++ b/products/openembedded/product.yml
@@ -18,3 +18,8 @@ cpes:
       name: "cpe:/o:openembedded:nodistro:"
       title: "OpenEmbedded nodistro"
       check_id: installed_OS_is_openembedded
+
+  - poky:
+      name: "cpe:/o:openembedded:poky:"
+      title: "Poky reference distribution"
+      check_id: installed_OS_is_poky
diff --git a/products/openembedded/transforms/constants.xslt b/products/openembedded/transforms/constants.xslt
index 152571e8bb..8901def2f9 100644
--- a/products/openembedded/transforms/constants.xslt
+++ b/products/openembedded/transforms/constants.xslt
@@ -2,8 +2,8 @@
 
 <xsl:include href="../../../shared/transforms/shared_constants.xslt"/>
 
-<xsl:variable name="product_long_name">OpenEmbedded</xsl:variable>
-<xsl:variable name="product_short_name">openembedded</xsl:variable>
+<xsl:variable name="product_long_name">OpenEmbedded based distribution</xsl:variable>
+<xsl:variable name="product_short_name">OE distros</xsl:variable>
 <xsl:variable name="product_stig_id_name">empty</xsl:variable>
 <xsl:variable name="prod_type">openembedded</xsl:variable>
 
diff --git a/shared/checks/oval/installed_OS_is_poky.xml b/shared/checks/oval/installed_OS_is_poky.xml
new file mode 100644
index 0000000000..9c41acd786
--- /dev/null
+++ b/shared/checks/oval/installed_OS_is_poky.xml
@@ -0,0 +1,33 @@
+<def-group>
+  <definition class="inventory" id="installed_OS_is_poky" version="1">
+    <metadata>
+      <title>Poky</title>
+      <affected family="unix">
+        <platform>multi_platform_all</platform>
+      </affected>
+      <description>The operating system installed is a Poky referenece based System</description>
+    </metadata>
+    <criteria comment="System is Poky reference distribution" operator="AND">
+      <extend_definition comment="Installed OS is part of the Unix family" definition_ref="installed_OS_is_part_of_Unix_family" />
+      <criterion comment="Poky based distro" test_ref="test_os_release_poky" />
+      <criterion comment="Poky referenece distribution is installed" test_ref="test_poky" />
+    </criteria>
+  </definition>
+
+  <unix:file_test check="all" check_existence="all_exist" comment="/etc/os-release exists" id="test_os_release_poky" version="1">
+    <unix:object object_ref="obj_os_release_poky" />
+  </unix:file_test>
+  <unix:file_object comment="check /etc/os-release file" id="obj_os_release_poky" version="1">
+    <unix:filepath>/etc/os-release</unix:filepath>
+  </unix:file_object>
+
+  <ind:textfilecontent54_test check="all" check_existence="at_least_one_exists" comment="Check OpenEmbedded" id="test_poky" version="1">
+    <ind:object object_ref="obj_poky" />
+  </ind:textfilecontent54_test>
+  <ind:textfilecontent54_object id="obj_poky" version="1" comment="Check Poky">
+    <ind:filepath>/etc/os-release</ind:filepath>
+    <ind:pattern operation="pattern match">^ID=poky$</ind:pattern>
+    <ind:instance datatype="int">1</ind:instance>
+  </ind:textfilecontent54_object>
+
+</def-group>
diff --git a/shared/checks/oval/sysctl_kernel_ipv6_disable.xml b/shared/checks/oval/sysctl_kernel_ipv6_disable.xml
index 4f22df262c..93975ef4b0 100644
--- a/shared/checks/oval/sysctl_kernel_ipv6_disable.xml
+++ b/shared/checks/oval/sysctl_kernel_ipv6_disable.xml
@@ -15,8 +15,8 @@
 	<platform>multi_platform_rhel</platform>
 	<platform>multi_platform_rhv</platform>
 	<platform>multi_platform_sle</platform>
-    <platform>multi_platform_ubuntu</platform>
-    <platform>multi_platform_uos</platform>
+	<platform>multi_platform_ubuntu</platform>
+	<platform>multi_platform_uos</platform>
       </affected>
       <description>Disables IPv6 for all network interfaces.</description>
     </metadata>
diff --git a/ssg/constants.py b/ssg/constants.py
index 8a92eb6182..151df304e7 100644
--- a/ssg/constants.py
+++ b/ssg/constants.py
@@ -51,6 +51,7 @@ product_directories = [
     'ocp4',
     'rhcos4',
     'ol7', 'ol8', 'ol9',
+    'openembedded',
     'opensuse',
     'rhel7', 'rhel8', 'rhel9',
     'rhv4',
-- 
2.41.0

